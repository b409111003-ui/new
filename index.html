<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ç¤¾å€æ•£æ­¥å‹å–„åœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 14px;
    }
    .controls label { display: block; margin: 4px 0; }
    .controls select, .controls button { margin-top: 6px; }
    .controls button {
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- æ§åˆ¶é¸å–® -->
  <div class="controls">
    <label><input type="checkbox" value="water"> é£²æ°´æ©Ÿ</label>
    <label><input type="checkbox" value="convenience"> ä¾¿åˆ©å•†åº—</label>
    <label><input type="checkbox" value="market"> å¸‚å ´</label>
    <label><input type="checkbox" value="park"> å…¬åœ’</label>
    <label>æœå°‹åŠå¾‘ (å…¬å°º)ï¼š
      <select id="radiusInput">
        <option value="500" selected>500</option>
        <option value="1000">1000</option>
        <option value="1500">1500</option>
        <option value="2000">2000</option>
      </select>
    </label>
    <button id="searchBtn">æœå°‹é™„è¿‘</button>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map("map", { zoomControl: false }).setView([25.033964, 121.564468], 15);
    L.control.zoom({ position: "bottomright" }).addTo(map);

    // OSM åœ–è³‡
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // ä½¿ç”¨è€… icon
    const minionIcon = L.icon({
      iconUrl: "https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9d1-1f3fc.svg",
      iconSize: [48, 48],
      iconAnchor: [24, 48],
      popupAnchor: [0, -48]
    });

    // å…¶ä»– icon
    const icons = {
      water: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2910/2910768.png", iconSize: [30,30] }),
      convenience: L.icon({ iconUrl: "https://openmoji.org/data/color/svg/1F3EA.svg", iconSize: [30,30] }),
      market: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/415/415682.png", iconSize: [30,30] }),
      park: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/427/427735.png", iconSize: [30,30] })
    };

    // ä½¿ç”¨è€…ä½ç½®
    let userMarker, userLat, userLon;
    navigator.geolocation.watchPosition(pos => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      if (!userMarker) {
        userMarker = L.marker([userLat, userLon], { icon: minionIcon }).addTo(map)
          .bindPopup("ä½ åœ¨é€™è£¡ ğŸŸ¡");
        map.setView([userLat, userLon], 16);
      } else {
        userMarker.setLatLng([userLat, userLon]);
      }
    }, err => { console.error("å®šä½å¤±æ•—ï¼š", err); });

    // OSM é¡åˆ¥
    const categories = {
      water: 'node["amenity"="drinking_water"](around:RADIUS,LAT,LON);',
      convenience: 'node["shop"="convenience"](around:RADIUS,LAT,LON);',
      market: 'node["amenity"="marketplace"](around:RADIUS,LAT,LON);',
      park: 'way["leisure"="park"](around:RADIUS,LAT,LON);'
    };

    function buildOverpassQuery(lat, lon, radius, selections) {
      if (!selections || selections.length === 0) return null;
      let body = '[out:json][timeout:25];(';
      for (const sel of selections) {
        let fragment = categories[sel].replace(/RADIUS/g, radius).replace(/LAT/g, lat).replace(/LON/g, lon);
        body += "\n" + fragment;
      }
      body += '\n);out center;';
      return body;
    }

    let searchMarkers = [];
    let routeLine;

    document.getElementById("searchBtn").addEventListener("click", () => {
      if (!userMarker) { alert("å°šæœªå–å¾—å®šä½"); return; }
      const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(c => c.value);
      const radius = parseInt(document.getElementById("radiusInput").value) || 500;
      const query = buildOverpassQuery(userLat, userLon, radius, checked);
      if (!query) { alert("è«‹å…ˆé¸æ“‡è¦æœå°‹çš„é¡åˆ¥"); return; }

      searchMarkers.forEach(m => map.removeLayer(m));
      searchMarkers = [];
      if (routeLine) map.removeLayer(routeLine);

      fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "data=" + encodeURIComponent(query)
      })
      .then(r => r.json())
      .then(data => {
        data.elements.forEach(el => {
          const lat = el.lat || el.center?.lat;
          const lon = el.lon || el.center?.lon;
          if (!lat || !lon) return;

          let matchedType = null;
          if (el.tags) {
            if (el.tags.amenity==="drinking_water") matchedType="water";
            else if (el.tags.shop==="convenience") matchedType="convenience";
            else if (el.tags.amenity==="marketplace") matchedType="market";
            else if (el.tags.leisure==="park") matchedType="park";
          }

          const marker = L.marker([lat, lon], { icon: matchedType ? icons[matchedType]:undefined }).addTo(map);
          marker.bindPopup(`<b>${el.tags.name||matchedType||"åœ°é»"}</b><br><button onclick="routeTo(${lat},${lon})">å°èˆª</button>`);
          searchMarkers.push(marker);
        });
      })
      .catch(err => { console.error(err); alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); });
    });

    // æ™®é€šæ­¥è¡Œè·¯ç·š (ä¸ä½¿ç”¨ wheelchair)
    window.routeTo = function(destLat, destLon) {
      if (!userLat || !userLon) { alert("å°šæœªå–å¾—ä½¿ç”¨è€…ä½ç½®"); return; }
      if (routeLine) map.removeLayer(routeLine);

      const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFiNjY0MmZiMWI4NDQ0MDQ5ZjhkZGQ1NWI4MGFhZTRhIiwiaCI6Im11cm11cjY0In0="; // 
      const url = "https://api.openrouteservice.org/v2/directions/foot-walking";

      const body = {
        coordinates: [
          [userLon, userLat],
          [destLon, destLat]
        ]
      };

      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify(body)
      })
      .then(r => r.json())
      .then(data => {
        if (!data.features || data.features.length===0) { alert("ç„¡æ³•è¦åŠƒè·¯ç·š"); return; }
        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLine.getBounds());
      })
      .catch(err => { console.error(err); alert("è·¯ç·šè¦åŠƒå¤±æ•—"); });
    };
  </script>
</body>
</html>
