<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>社區散步友善地圖 + ORS 無障礙路線</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // 初始化地圖
    const map = L.map('map').setView([25.0330, 121.5654], 15);

    // 加入地圖圖層
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
    }).addTo(map);

    // 使用者 icon
    const userIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });

    let userMarker;

    // 取得定位
    map.locate({ setView: true, maxZoom: 16 });

    map.on("locationfound", (e) => {
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker(e.latlng, { icon: userIcon }).addTo(map)
        .bindPopup("您在這裡").openPopup();

      // 搜尋附近 500 公尺內的公園（Overpass API）
      const query = `
        [out:json];
        node(around:500, ${e.latitude}, ${e.longitude})[leisure=park];
        out;
      `;

      fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
      })
      .then(res => res.json())
      .then(data => {
        data.elements.forEach(p => {
          const park = L.marker([p.lat, p.lon]).addTo(map)
            .bindPopup("公園");
          park.on("click", () => {
            getORSRoute([e.longitude, e.latitude], [p.lon, p.lat]); // 注意經緯度順序
          });
        });
      });
    });

    map.on("locationerror", () => {
      alert("無法取得您的位置");
    });

    // 呼叫 ORS API：計算無障礙路線
    function getORSRoute(start, end) {
      const url = "https://api.openrouteservice.org/v2/directions/foot-walking/geojson";
      fetch(url, {
        method: "POST",
        headers: {
          "Authorization": "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjdhMjE3MWZjYzE3NjRhZmViY2ZiYzg4NWY2MzRiNmMxIiwiaCI6Im11cm11cjY0In0=",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          coordinates: [start, end],
          extra_info: ["wheelchair"] // 無障礙資訊
        })
      })
      .then(res => {
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
      })
      .then(json => {
        const coords = json.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
      })
      .catch(err => {
        console.error(err);
        alert("路線規劃失敗：" + err.message);
      });
    }
  </script>
</body>
</html>
