<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ç¤¾å€æ•£æ­¥å‹å–„åœ°åœ– + ORS ç„¡éšœç¤™è·¯ç·š</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    #map { height: 100vh; }
    .control-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="control-box">
    æœå°‹ç¯„åœï¼š
    <select id="radiusSelect">
      <option value="100">100 å…¬å°º</option>
      <option value="300">300 å…¬å°º</option>
      <option value="500" selected>500 å…¬å°º</option>
      <option value="1000">1000 å…¬å°º</option>
    </select>
    <button id="searchBtn">é‡æ–°æœå°‹</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // åˆå§‹åŒ–åœ°åœ–
    const map = L.map('map', { zoomControl: false }).setView([25.0330, 121.5654], 15);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
    }).addTo(map);

    // è‡ªè¨‚ icon
    const icons = {
      user: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/149/149071.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
      }),
      park: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/427/427735.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -30]
      }),
      water: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/728/728093.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -30]
      }),
      market: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3076/3076406.png",
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -30]
      }),
      store: L.divIcon({
        html: "ğŸª",
        className: "",
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
      })
    };

    let userMarker, lastLocation, poiMarkers = [], routeLine, searchCircle;

    // å®šä½
    map.locate({ setView: true, maxZoom: 16 });
    map.on("locationfound", (e) => {
      lastLocation = e.latlng;
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker(e.latlng, { icon: icons.user }).addTo(map).bindPopup("æ‚¨åœ¨é€™è£¡").openPopup();
      searchNearby();
    });
    map.on("locationerror", () => alert("ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®"));

    // æœå°‹é™„è¿‘ POI
    function searchNearby() {
      if (!lastLocation) return;
      const radius = document.getElementById("radiusSelect").value;

      // æ¸…æ‰èˆŠçš„ POI & åœ“åœˆ
      poiMarkers.forEach(m => map.removeLayer(m));
      poiMarkers = [];
      if (searchCircle) map.removeLayer(searchCircle);

      // ç•«æœå°‹ç¯„åœåœ“åœˆ
      searchCircle = L.circle(lastLocation, {
        radius: radius,
        color: "red",
        weight: 1,
        fillOpacity: 0.1
      }).addTo(map);

      const query = `
        [out:json];
        (
          node(around:${radius}, ${lastLocation.lat}, ${lastLocation.lng})[leisure=park];
          node(around:${radius}, ${lastLocation.lat}, ${lastLocation.lng})[amenity=drinking_water];
          node(around:${radius}, ${lastLocation.lat}, ${lastLocation.lng})[shop=convenience];
          node(around:${radius}, ${lastLocation.lat}, ${lastLocation.lng})[shop=supermarket];
        );
        out;
      `;

      fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query })
      .then(res => res.json())
      .then(data => {
        data.elements.forEach(p => {
          let icon = icons.park, label = "å…¬åœ’";
          if (p.tags.amenity === "drinking_water") { icon = icons.water; label = "é£²æ°´æ©Ÿ"; }
          else if (p.tags.shop === "supermarket") { icon = icons.market; label = "å¸‚å ´"; }
          else if (p.tags.shop === "convenience") { icon = icons.store; label = "ä¾¿åˆ©å•†åº—"; }

          const marker = L.marker([p.lat, p.lon], { icon }).addTo(map).bindPopup(label);
          poiMarkers.push(marker);
          marker.on("click", () => getORSRoute([lastLocation.lng, lastLocation.lat], [p.lon, p.lat]));
        });
      });
    }

    // ORS API è·¯ç·š
    function getORSRoute(start, end) {
      if (routeLine) map.removeLayer(routeLine);
      const url = "https://api.openrouteservice.org/v2/directions/foot-walking/geojson";
      fetch(url, {
        method: "POST",
        headers: {
          "Authorization": "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjdhMjE3MWZjYzE3NjRhZmViY2ZiYzg4NWY2MzRiNmMxIiwiaCI6Im11cm11cjY0In0=",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: [start, end], extra_info: ["wheelchair"] })
      })
      .then(res => {
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
      })
      .then(json => {
        const coords = json.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLine.getBounds());
      })
      .catch(err => alert("è·¯ç·šè¦åŠƒå¤±æ•—ï¼š" + err.message));
    }

    // ç¶å®šæŒ‰éˆ•
    document.getElementById("searchBtn").addEventListener("click", searchNearby);
  </script>
</body>
</html>
