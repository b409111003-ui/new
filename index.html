<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<title>é«˜é½¡è€…å‹å–„æ•£æ­¥åœ°åœ–</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
body, html {margin:0; padding:0; height:100%;}
#map {width:100%; height:100%;}
.controls {position:absolute; top:10px; left:10px; background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:1000; font-size:14px;}
.controls label{display:block; margin:4px 0;}
.controls input, .controls button{margin-top:6px;}
.controls button{padding:4px 8px; border-radius:6px; border:none; background:#4CAF50; color:white; cursor:pointer;}
</style>
</head>
<body>
<div class="controls">
  <label><input type="checkbox" value="water"> é£²æ°´æ©Ÿ</label>
  <label><input type="checkbox" value="convenience"> ä¾¿åˆ©å•†åº—</label>
  <label><input type="checkbox" value="market"> å¸‚å ´</label>
  <label><input type="checkbox" value="park"> å…¬åœ’</label>
  <label>æœå°‹åŠå¾‘ (å…¬å°º)ï¼š<input type="number" id="radiusInput" value="500" min="100" step="100"></label>
  <button id="searchBtn">æœå°‹é™„è¿‘</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// åˆå§‹åŒ–åœ°åœ–
const map = L.map("map",{zoomControl:false}).setView([25.033964,121.564468],15);
L.control.zoom({position:"bottomright"}).addTo(map);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);

// ä½¿ç”¨è€…ä½ç½® icon
const minionIcon = L.icon({iconUrl:"https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9d1-1f3fc.svg",iconSize:[48,48],iconAnchor:[24,48],popupAnchor:[0,-48]});

// ä¼‘æ¯é» icon
const icons = {
  water:L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/2910/2910768.png",iconSize:[30,30]}),
  convenience:L.icon({iconUrl:"https://openmoji.org/data/color/svg/1F3EA.svg",iconSize:[30,30]}),
  market:L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/415/415682.png",iconSize:[30,30]}),
  park:L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/427/427735.png",iconSize:[30,30]})
};

// ä½¿ç”¨è€…å®šä½
let userMarker,userLat,userLon;
navigator.geolocation.watchPosition(pos=>{
  userLat = pos.coords.latitude;
  userLon = pos.coords.longitude;
  if(!userMarker){
    userMarker = L.marker([userLat,userLon],{icon:minionIcon}).addTo(map).bindPopup("ä½ åœ¨é€™è£¡ ğŸŸ¡");
    map.setView([userLat,userLon],16);
  } else userMarker.setLatLng([userLat,userLon]);
}, err=>{console.error("å®šä½å¤±æ•—", err);});

// OSM é¡åˆ¥èˆ‡é™„åŠ æœå°‹ bench
const categories = {
  water:'node["amenity"="drinking_water"](around:RADIUS,LAT,LON);',
  convenience:'node["shop"="convenience"](around:RADIUS,LAT,LON);',
  market:'node["amenity"="marketplace"](around:RADIUS,LAT,LON);',
  park:'way["leisure"="park"](around:RADIUS,LAT,LON);node["amenity"="bench"](around:RADIUS,LAT,LON);'
};

// çµ„åˆ Overpass Query
function buildOverpassQuery(lat,lon,radius,selections){
  if(!selections||selections.length===0) return null;
  let body='[out:json][timeout:25];(';
  for(const sel of selections){
    let f = categories[sel].replace(/RADIUS/g,radius).replace(/LAT/g,lat).replace(/LON/g,lon);
    body += "\n" + f;
  }
  body += '\n);out center;';
  return body;
}

let searchMarkers=[]; let routeLine;

// æœå°‹é™„è¿‘
document.getElementById("searchBtn").addEventListener("click",()=>{
  if(!userMarker){alert("å°šæœªå–å¾—å®šä½"); return;}
  const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
  let radius = parseInt(document.getElementById("radiusInput").value);
  if(isNaN(radius)||radius<=0) radius=500;

  const query = buildOverpassQuery(userLat,userLon,radius,checked);
  if(!query){alert("è«‹å…ˆé¸æ“‡è¦æœå°‹çš„é¡åˆ¥"); return;}

  searchMarkers.forEach(m=>map.removeLayer(m)); searchMarkers=[];
  if(routeLine) map.removeLayer(routeLine);

  fetch("https://overpass-api.de/api/interpreter",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"data="+encodeURIComponent(query)})
  .then(r=>r.json()).then(data=>{
    data.elements.forEach(el=>{
      const lat=el.lat||el.center?.lat;
      const lon=el.lon||el.center?.lon;
      if(!lat||!lon) return;

      let matchedType=null;
      if(el.tags){
        if(el.tags.amenity==="drinking_water") matchedType="water";
        else if(el.tags.shop==="convenience") matchedType="convenience";
        else if(el.tags.amenity==="marketplace") matchedType="market";
        else if(el.tags.leisure==="park" || el.tags.amenity==="bench") matchedType="park";
      }

      const distance = Math.round(map.distance([userLat,userLon],[lat,lon]));
      let description="";
      if(matchedType==="park") description="å¹³åœ°ä¼‘æ†©åœ’å€ / æœ‰åº§æ¤…";
      else if(matchedType==="water") description="æä¾›é£²æ°´ / é™„è¿‘å¯å";
      else if(matchedType==="convenience") description="ä¾¿åˆ©å•†åº— / å¯åä¼‘æ¯";
      else if(matchedType==="market") description="å¸‚å ´ / å¯çŸ­æš«ä¼‘æ¯";

      const marker = L.marker([lat,lon],{icon:matchedType?icons[matchedType]:undefined}).addTo(map);
      marker.bindPopup(
        `<b>${el.tags.name||matchedType||"åœ°é»"}</b><br>`+
        `é¡å‹: ${matchedType||"æœªçŸ¥"}<br>`+
        `å¯åä¸‹ä¼‘æ¯: æ˜¯<br>`+
        `è·é›¢èµ·é»: ${distance} å…¬å°º<br>`+
        `${description}<br>`+
        `<button onclick="routeTo(${lat},${lon})">å°èˆª</button>`
      );
      searchMarkers.push(marker);
    });
  }).catch(err=>{console.error(err); alert("æŸ¥è©¢å¤±æ•—");});
});

// è·¯ç·šè¦åŠƒ
function routeTo(destLat,destLon){
  if(!userLat||!userLon){alert("å°šæœªå–å¾—ä½ç½®"); return;}
  if(routeLine) map.removeLayer(routeLine);

  const url=`https://router.project-osrm.org/route/v1/foot/${userLon},${userLat};${destLon},${destLat}?overview=full&geometries=geojson`;
  fetch(url).then(r=>r.json()).then(data=>{
    if(!data.routes||data.routes.length===0){alert("ç„¡æ³•è¦åŠƒè·¯ç·š"); return;}
    const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine = L.polyline(coords,{color:"blue",weight:5}).addTo(map);

    // æ¯ 300 å…¬å°ºå»ºè­°ä¼‘æ¯é»
    let segmentDist = 0.3; // km
    let points=[coords[0]]; let accDist=0;
    for(let i=1;i<coords.length;i++){
      const prev=coords[i-1]; const cur=coords[i];
      const d=Math.sqrt(Math.pow(prev[0]-cur[0],2)+Math.pow(prev[1]-cur[1],2))*111;
      accDist+=d;
      if(accDist>=segmentDist){ points.push(cur); accDist=0; }
    }
    points.push(coords[coords.length-1]);
    points.forEach((p,i)=>{
      const restMarker = L.circleMarker(p,{radius:6,color:"green",fillColor:"green",fillOpacity:0.8}).addTo(map);
      const distFromStart = Math.round(map.distance([userLat,userLon],p));
      restMarker.bindPopup(`å»ºè­°ä¼‘æ¯é»<br>è·é›¢èµ·é»: ${distFromStart} å…¬å°º<br>å¯åä¸‹ä¼‘æ¯`);
    });

    map.fitBounds(routeLine.getBounds());
  }).catch(err=>{console.error(err); alert("è·¯ç·šè¦åŠƒå¤±æ•—");});
}
</script>
</body>
</html>

