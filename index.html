<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>社區散步友善地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    #map { height: 100vh; }
    .controls {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000; font-size: 14px;
    }
    .controls label { display: block; margin: 4px 0; }
    .controls input[type="number"] { width: 80px; }
    .controls button {
      margin-top: 6px; padding: 4px 8px; border-radius: 6px;
      border: none; background: #4CAF50; color: white; cursor: pointer;
    }
  </style>
</head>
<body>
<div class="controls">
  <label><input type="checkbox" value="water"> 飲水機</label>
  <label><input type="checkbox" value="convenience"> 便利商店</label>
  <label><input type="checkbox" value="market"> 市場</label>
  <label><input type="checkbox" value="park"> 公園</label>
  <label>搜尋半徑 (公尺)：<input type="number" id="radiusInput" value="500" min="100" step="100"></label>
  <button id="searchBtn">搜尋附近</button>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// 初始化地圖
const map = L.map('map', { zoomControl: false }).setView([25.0330, 121.5654], 15);
L.control.zoom({ position: "bottomright" }).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '© OpenStreetMap'
}).addTo(map);

// 使用者位置（小黃人 icon）
const userIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/3089/3089766.png", // 小黃人
  iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
});
let userMarker, userPos;
navigator.geolocation.watchPosition(pos => {
  const lat = pos.coords.latitude, lon = pos.coords.longitude;
  userPos = [lat, lon];
  if (!userMarker) {
    userMarker = L.marker(userPos, { icon: userIcon }).addTo(map).bindPopup("你在這裡");
    map.setView(userPos, 16);
  } else {
    userMarker.setLatLng(userPos);
  }
});

// Icon 定義
const icons = {
  water: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/2910/2910768.png", iconSize: [30, 30] }),
  convenience: L.icon({ iconUrl: "https://openmoji.org/data/color/svg/1F3EA.svg", iconSize: [30, 30] }),
  market: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/415/415682.png", iconSize: [30, 30] }),
  park: L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/427/427735.png", iconSize: [30, 30] })
};

// 分類對應 OSM
const categories = {
  water: 'node["amenity"="drinking_water"](around:RADIUS,LAT,LON);',
  convenience: 'node["shop"="convenience"](around:RADIUS,LAT,LON);',
  market: 'node["amenity"="marketplace"](around:RADIUS,LAT,LON);',
  park: 'way["leisure"="park"](around:RADIUS,LAT,LON);'
};

// 組合 Overpass Query
function buildOverpassQuery(lat, lon, radius, selections) {
  if (!selections || selections.length === 0) return null;
  let body = '[out:json][timeout:25];(';
  for (const sel of selections) {
    let fragment = categories[sel];
    fragment = fragment.replace(/RADIUS/g, radius).replace(/LAT/g, lat).replace(/LON/g, lon);
    body += "\n" + fragment;
  }
  body += '\n);out center;';
  return body;
}

// 搜尋並顯示
let searchMarkers = [];
let currentRoute;

document.getElementById("searchBtn").addEventListener("click", () => {
  if (!userMarker) { alert("尚未取得定位"); return; }
  const pos = userMarker.getLatLng();
  const checked = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(c => c.value);
  const radius = parseInt(document.getElementById("radiusInput").value) || 500;
  const query = buildOverpassQuery(pos.lat, pos.lng, radius, checked);
  if (!query) { alert("請先選擇要搜尋的類別"); return; }

  // 清除舊的搜尋結果與路線
  searchMarkers.forEach(m => map.removeLayer(m));
  searchMarkers = [];
  if (currentRoute) { map.removeLayer(currentRoute); currentRoute = null; }

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: "data=" + encodeURIComponent(query)
  })
  .then(r => r.json())
  .then(data => {
    data.elements.forEach(el => {
      const lat = el.lat || el.center?.lat;
      const lon = el.lon || el.center?.lon;
      if (!lat || !lon) return;

      let matchedType = null;
      if (el.tags) {
